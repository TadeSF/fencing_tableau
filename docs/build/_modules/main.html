<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>main &mdash; FenceWithFriends  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> FenceWithFriends
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../Userguide.html">Userguide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Principles.html">Main Principles and Program Desing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../main.html">Main</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tournament.html">Tournament Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../match.html">Match Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fencer.html">Fencer Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../piste.html">Piste Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Utilities.html">Utilities</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">FenceWithFriends</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">main</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for main</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">csv</span>
    <span class="kn">import</span> <span class="nn">datetime</span>
    <span class="kn">import</span> <span class="nn">hashlib</span>
    <span class="kn">import</span> <span class="nn">hmac</span>
    <span class="kn">import</span> <span class="nn">logging</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">import</span> <span class="nn">pickle</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="kn">import</span> <span class="nn">threading</span>
    <span class="kn">import</span> <span class="nn">traceback</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Literal</span>

    <span class="kn">import</span> <span class="nn">bcrypt</span>
    <span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Flask</span><span class="p">,</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span>
                       <span class="n">redirect</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_file</span><span class="p">,</span>
                       <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">url_for</span><span class="p">)</span>

    <span class="kn">import</span> <span class="nn">_version</span>
    <span class="kn">import</span> <span class="nn">attr_checker</span>
    <span class="kn">import</span> <span class="nn">random_generator</span>
    <span class="kn">from</span> <span class="nn">exceptions</span> <span class="kn">import</span> <span class="o">*</span>
    <span class="kn">from</span> <span class="nn">fencer</span> <span class="kn">import</span> <span class="n">Fencer</span><span class="p">,</span> <span class="n">Stage</span><span class="p">,</span> <span class="n">Wildcard</span>
    <span class="kn">from</span> <span class="nn">match</span> <span class="kn">import</span> <span class="n">EliminationMatch</span><span class="p">,</span> <span class="n">GroupMatch</span>
    <span class="kn">from</span> <span class="nn">piste</span> <span class="kn">import</span> <span class="n">Piste</span>
    <span class="kn">from</span> <span class="nn">tournament</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">except</span> <span class="ne">ModuleNotFoundError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">RequiredLibraryError</span><span class="p">(</span><span class="s2">&quot;Please install all required libraries by running &#39;pip install -r requirements.txt&#39;&quot;</span><span class="p">)</span>

<span class="c1"># ------- Dotenv -------</span>
<span class="n">load_dotenv</span><span class="p">()</span>
<span class="n">github_secret</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;GITHUB_SECRET&#39;</span><span class="p">)</span>

<span class="c1"># ------- Versioning -------</span>
<span class="n">APP_VERSION</span> <span class="o">=</span> <span class="n">_version</span><span class="o">.</span><span class="n">VERSION</span>


<span class="c1"># ------- Tournament Cache -------</span>
<span class="n">enable_tournament_cache</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">tournament_cache</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tournament</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">cache_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<div class="viewcode-block" id="get_tournament"><a class="viewcode-back" href="../main.html#main.get_tournament">[docs]</a><span class="k">def</span> <span class="nf">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tournament</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function returns a tournament from the tournament cache, given an id.</span>
<span class="sd">    If the tournament with the given id does not exist, it returns None.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament to be returned.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tournament object</span>
<span class="sd">        if the tournament exists</span>
<span class="sd">    None</span>
<span class="sd">        if the tournament does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">tournament_cache</span><span class="p">,</span> <span class="n">cache_lock</span><span class="p">,</span> <span class="n">enable_tournament_cache</span>

    <span class="k">if</span> <span class="n">enable_tournament_cache</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cache_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tournament</span> <span class="ow">in</span> <span class="n">tournament_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tournament</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">tournament_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tournament</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">load_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_tournament_exists"><a class="viewcode-back" href="../main.html#main.check_tournament_exists">[docs]</a><span class="k">def</span> <span class="nf">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a tournament with given id exists in the tournament cache.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament to be checked.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    True</span>
<span class="sd">        if the tournament exists</span>
<span class="sd">    False</span>
<span class="sd">        if the tournament does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">tournament_cache</span><span class="p">,</span> <span class="n">cache_lock</span><span class="p">,</span> <span class="n">enable_tournament_cache</span>

    <span class="k">if</span> <span class="n">enable_tournament_cache</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">cache_lock</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tournament</span> <span class="ow">in</span> <span class="n">tournament_cache</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tournament</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">tournament_id</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">)</span></div>


<span class="c1"># ------- Pickeling -------</span>
<span class="c1"># Pickeling is an easy way to save data to a file, so that it stays persistent even if the server has to restart.</span>



<span class="k">def</span> <span class="nf">create_local_tournament_folder</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function creates a folder called &quot;tournaments&quot; in the root directory, if it does not already exist.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;tournament_cache&#39;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="s1">&#39;tournament_cache&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="save_tournament"><a class="viewcode-back" href="../main.html#main.save_tournament">[docs]</a><span class="k">def</span> <span class="nf">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">:</span> <span class="n">Tournament</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function saves a tournament to a file, so that it can be loaded again later, even if the server has to restart.</span>
<span class="sd">    This is done by pickeling a tournament object. The file is saved in the /tournaments folder and is named after the tournament id.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament : Tournament</span>
<span class="sd">        The tournament to be saved.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">create_local_tournament_folder</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">tournament</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">tournament</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span></div>

<span class="k">def</span> <span class="nf">load_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tournament</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads a tournament from a file, given an id.</span>
<span class="sd">    This is done by pickeling a tournament object. The file is saved in the /tournaments folder and is named after the tournament id.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament to be loaded.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tournament object</span>
<span class="sd">        if the tournament exists</span>
<span class="sd">    None</span>
<span class="sd">        if the tournament does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">create_local_tournament_folder</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">tournament</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tournament</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="load_all_tournaments"><a class="viewcode-back" href="../main.html#main.load_all_tournaments">[docs]</a><span class="k">def</span> <span class="nf">load_all_tournaments</span><span class="p">(</span><span class="n">return_values</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function loads all saved tournaments from the /tournaments folder and adds them to the tournament cache.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">tournament_cache</span><span class="p">,</span> <span class="n">cache_lock</span>
    <span class="n">tournaments</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">cache_lock</span><span class="p">:</span>
        <span class="n">create_local_tournament_folder</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;tournament_cache&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.pickle&#39;</span><span class="p">):</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">tournament</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tournaments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">return_values</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">tournaments</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament_cache</span> <span class="o">=</span> <span class="n">tournaments</span></div>


<div class="viewcode-block" id="delete_old_tournaments"><a class="viewcode-back" href="../main.html#main.delete_old_tournaments">[docs]</a><span class="k">def</span> <span class="nf">delete_old_tournaments</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function deletes all tournament files that are older than 1 day from the /tournaments folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">tournament_cache</span><span class="p">,</span> <span class="n">cache_lock</span>
    <span class="k">with</span> <span class="n">cache_lock</span><span class="p">:</span>
        <span class="n">create_local_tournament_folder</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">tournament</span> <span class="ow">in</span> <span class="n">tournament_cache</span><span class="p">:</span>
            <span class="c1"># Delete the tournament.pickle file if it is older than 1 day</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">tournament</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tournament_cache/</span><span class="si">{</span><span class="n">tournament</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s1">.pickle&#39;</span><span class="p">)</span>
                <span class="n">tournament_cache</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span></div>



<span class="c1"># ------- Login-Cookies -------</span>
<span class="k">def</span> <span class="nf">create_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">clearence</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;referee&quot;</span><span class="p">,</span> <span class="s2">&quot;fencer&quot;</span><span class="p">],</span> <span class="n">fencer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cookie_value</span> <span class="o">=</span> <span class="n">random_generator</span><span class="o">.</span><span class="n">cookie</span><span class="p">()</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span><span class="p">:</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">master_cookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie_value</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">tournament_id</span> <span class="o">+</span> <span class="s2">&quot;_master&quot;</span><span class="p">,</span> <span class="n">cookie_value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># 7 days</span>
    <span class="k">if</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;referee&quot;</span><span class="p">:</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">referee_cookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie_value</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">tournament_id</span> <span class="o">+</span> <span class="s2">&quot;_referee&quot;</span><span class="p">,</span> <span class="n">cookie_value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># 7 days</span>
    <span class="k">if</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;fencer&quot;</span><span class="p">:</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_by_id</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">)</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cookie_value</span><span class="p">)</span>
        <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="n">tournament_id</span> <span class="o">+</span> <span class="s2">&quot;_fencer_&quot;</span> <span class="o">+</span> <span class="n">fencer_id</span><span class="p">,</span> <span class="n">cookie_value</span><span class="p">,</span> <span class="n">max_age</span><span class="o">=</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># 7 days</span>

    <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created </span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2"> cookie for tournament </span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2"> with value </span><span class="si">{</span><span class="n">cookie_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

<span class="k">def</span> <span class="nf">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">clearence</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;master&quot;</span><span class="p">,</span> <span class="s2">&quot;referee&quot;</span><span class="p">,</span> <span class="s2">&quot;fencer&quot;</span><span class="p">],</span> <span class="n">fencer_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;master&quot;</span> <span class="ow">or</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;referee&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cookie_name</span><span class="p">,</span> <span class="n">cookie_value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cookie_name</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cookie_value</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">),</span> <span class="n">clearence</span> <span class="o">+</span> <span class="s2">&quot;_cookies&quot;</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2"> cookie for tournament </span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2"> with value </span><span class="si">{</span><span class="n">cookie_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
    
    <span class="k">elif</span> <span class="n">clearence</span> <span class="o">==</span> <span class="s2">&quot;fencer&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cookie_name</span><span class="p">,</span> <span class="n">cookie_value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cookie_name</span> <span class="o">==</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">fencer_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cookie_value</span> <span class="ow">in</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_fencer_by_id</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">)</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2"> cookie for tournament </span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2"> with value </span><span class="si">{</span><span class="n">cookie_value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Did not find </span><span class="si">{</span><span class="n">clearence</span><span class="si">}</span><span class="s2"> cookie for tournament </span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ------- Searches -------</span>
<span class="k">def</span> <span class="nf">search_fencer</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">fencer_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Fencer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function searches for a fencer in a tournament, given the tournament id and the fencer id.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament to be searched in.</span>
<span class="sd">    fencer_id : str</span>
<span class="sd">        The id of the fencer to be searched for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Fencer object</span>
<span class="sd">        if the fencer exists</span>
<span class="sd">    None</span>
<span class="sd">        if the fencer does not exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">fencer</span> <span class="ow">in</span> <span class="n">tournament</span><span class="o">.</span><span class="n">fencers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fencer</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">fencer_id</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fencer</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="c1"># ------- CSV -------</span>

<span class="k">def</span> <span class="nf">check_csv</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a csv file is valid and returns a list of fencers.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file : csv file</span>
<span class="sd">        The csv file to be checked.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list of Fencer objects</span>
<span class="sd">        if the csv file is valid</span>
<span class="sd">    None</span>
<span class="sd">        if the csv file is not valid</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    CSVError</span>
<span class="sd">        if the csv file is not valid and provides a description of the error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">headers</span> <span class="o">!=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Club&#39;</span><span class="p">,</span> <span class="s1">&#39;Nationality&#39;</span><span class="p">,</span> <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Handedness&#39;</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">CSVError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid headers</span><span class="se">\n\n</span><span class="s2">Must be </span><span class="si">{</span><span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Club&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Nationality&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Gender&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Handedness&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Age&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">row_number</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">row_number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CSVError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid number of columns in row </span><span class="si">{</span><span class="n">row_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">club</span><span class="p">,</span> <span class="n">nationality</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">handedness</span><span class="p">,</span> <span class="n">age</span> <span class="o">=</span> <span class="n">row</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_club</span><span class="p">(</span><span class="n">club</span><span class="p">)</span>
            <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_nationality</span><span class="p">(</span><span class="n">nationality</span><span class="p">)</span>
            <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_gender</span><span class="p">(</span><span class="n">gender</span><span class="p">)</span>
            <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_handedness</span><span class="p">(</span><span class="n">handedness</span><span class="p">)</span>
            <span class="n">age</span> <span class="o">=</span> <span class="n">attr_checker</span><span class="o">.</span><span class="n">check_age</span><span class="p">(</span><span class="n">age</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">CSVError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid attribute in row </span><span class="si">{</span><span class="n">row_number</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="n">body</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">name</span><span class="p">,</span> <span class="n">club</span><span class="p">,</span> <span class="n">nationality</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">handedness</span><span class="p">,</span> <span class="n">age</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">CSVError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;CSV file does not contain enough (or any) fencers. Please add at least 3 fencers.&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">body</span>

<span class="c1"># ------- Passwords -------</span>
<span class="k">def</span> <span class="nf">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function hashes a password using the bcrypt algorithm.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    password : str</span>
<span class="sd">        The password to be hashed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        The hashed password.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">salt</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">gensalt</span><span class="p">()</span>
    <span class="n">hashed_password</span> <span class="o">=</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">hashpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">salt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">hashed_password</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">hashed_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function checks if a password matches a hashed password.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    password : str</span>
<span class="sd">        The password to be checked.</span>
<span class="sd">    hashed_password : str</span>
<span class="sd">        The hashed password to be checked against.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        True if the password matches the hashed password.</span>
<span class="sd">        False if the password does not match the hashed password.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">bcrypt</span><span class="o">.</span><span class="n">checkpw</span><span class="p">(</span><span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">hashed_password</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>


<span class="c1"># ------- Flask -------</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s1">&#39;static&#39;</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s1">&#39;templates&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/favicon.ico&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">favicon</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request /favicon.ico the favicon.ico file from the static folder.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    send_from_directory(favicon.ico)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">),</span> <span class="s1">&#39;favicon.ico&#39;</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/vnd.microsoft.icon&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="index"><a class="viewcode-back" href="../main.html#main.index">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request / the index.html file from the templates folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;User-Agent&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;mobile&quot;</span> <span class="ow">in</span> <span class="n">user_agent</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;mobile_index&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">APP_VERSION</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/m&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">mobile_index</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request / the index.html file from the templates folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;m_index.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">APP_VERSION</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/imprint&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">imprint</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;imprint.html&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/privacy&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">privacy</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;privacy.html&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/csv-template&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">csv_template_download</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="s2">&quot;static/template.csv&quot;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/example-startlist&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">example_startlist_download</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="s2">&quot;static/example_startlist.csv&quot;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/build-your-startlist&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">build_your_startlist</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">startlist_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">random_generator</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;build_your_startlist&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">startlist_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s2">&quot;build_your_startlist&quot;</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;build_your_startlist&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created build_your_startlist folder&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Name,Club,Nationality,Gender,Handedness,Age&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;build_your_startlist.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">APP_VERSION</span><span class="p">,</span> <span class="n">startlist_id</span><span class="o">=</span><span class="n">startlist_id</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/build-your-startlist/get-startlist&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_startlist</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>

    <span class="c1"># try:</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;startlist&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">line</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]}</span>

    <span class="c1"># except Exception as e:</span>
    <span class="c1">#     return {&quot;success&quot;: False, &quot;message&quot;: str(e)}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/build-your-startlist/add-fencer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">add_fencer</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startlist_id&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">club</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;club&quot;</span><span class="p">)</span>
    <span class="n">nationality</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nationality&quot;</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gender&quot;</span><span class="p">)</span>
    <span class="n">handedness</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;handedness&quot;</span><span class="p">)</span>
    <span class="n">age</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">club</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">nationality</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">gender</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">handedness</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">age</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/build-your-startlist/delete-fencer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">delete_fencer</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;startlist_id&quot;</span><span class="p">)</span>
    <span class="n">row_number</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;row_number&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">row_number</span><span class="p">))</span>
            <span class="c1"># remove the last &quot;\n&quot;</span>
            <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}</span>



<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/build-your-startlist/save-startlist&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">save_startlist</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is responsible for saving a startlist, which is a list of fencers and their corresponding bout numbers, to a CSV file.</span>
<span class="sd">    The function is called when the user clicks the button to save a startlist. The function takes the ID of the startlist as an argument</span>
<span class="sd">    and then creates a CSV file by calling the send_file() function. The file is named fencing_startlist_{startlist_id}.csv and is </span>
<span class="sd">    automatically downloaded by the user&#39;s browser.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">startlist_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;build_your_startlist/</span><span class="si">{</span><span class="n">startlist_id</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">as_attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/tournaments&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tournaments</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request /tournaments the tournaments.html file from the templates folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">cards</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">tournament</span> <span class="ow">in</span> <span class="n">load_all_tournaments</span><span class="p">(</span><span class="n">return_values</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">tournament_id</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">id</span>
        <span class="n">tournament_id_with_parenthesies</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">name</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">.%m.%Y %H:%M&quot;</span><span class="p">)</span>
        <span class="n">cards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&lt;div class=&quot;grid-item&quot;&gt;&lt;div class=&quot;ID-Block&quot;&gt;&lt;div class=&quot;ID-Block-Number&quot;&gt;</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s1">&lt;/div&gt;&lt;div class=&quot;ID-Block-Description&quot;&gt;Tournament ID&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;Name&quot;&gt;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&lt;/div&gt;&lt;div class=&quot;date&quot;&gt;</span><span class="si">{</span><span class="n">date</span><span class="si">}</span><span class="s1">&lt;/div&gt;&lt;div class=&quot;button-box&quot;&gt;&lt;div class=&quot;button&quot; onclick=&quot;ManageTournament(</span><span class="si">{</span><span class="n">tournament_id_with_parenthesies</span><span class="si">}</span><span class="s1">)&quot;&gt;Manage Tournament&lt;/div&gt;&lt;div class=&quot;button&quot; onclick=&quot;LoginAsFencer(</span><span class="si">{</span><span class="n">tournament_id_with_parenthesies</span><span class="si">}</span><span class="s1">)&quot;&gt;Login as Fencer&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">cards</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&lt;div class=&quot;grid-item&quot; style=&quot;grid-column: span 3;&quot;&gt;&lt;div class=&quot;Name&quot;&gt;No Tournaments&lt;/div&gt;&lt;/div&gt;&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;tournaments.html&#39;</span><span class="p">,</span> <span class="n">cards</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cards</span><span class="p">))</span>

<div class="viewcode-block" id="process_form"><a class="viewcode-back" href="../main.html#main.process_form">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">process_form</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start a new Tournament:</span>
<span class="sd">    Flask processes a POST request that contains infos on a new tournament.</span>
<span class="sd">    It creates a new tournament object and adds it to the tournament cache as well as saving it to a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the tournament.</span>
<span class="sd">    fencers : file</span>
<span class="sd">        A csv file containing the fencers with the Headers Name, Club, Nationality, Gender, Handedness. Nationality has to be the alpha-3 Countrycode. Gender and Handedness are optional.</span>
<span class="sd">    location : str</span>
<span class="sd">        The location of the tournament.</span>
<span class="sd">    pistes : int</span>
<span class="sd">        The number of pistes.</span>
<span class="sd">    first_elimination_round : int</span>
<span class="sd">        The first elimination round (by default, this will be calculated automaticly)</span>
<span class="sd">    elimination_mode : str</span>
<span class="sd">        The elimination mode (manager can choose between &quot;KO&quot;, &quot;Placement&quot; or &quot;Repechage&quot;)</span>
<span class="sd">    preliminary_rounds : int</span>
<span class="sd">        The number of preliminary rounds.</span>
<span class="sd">    preliminary_groups : int</span>
<span class="sd">        The number of preliminary groups (by default, this will be calculated automaticly)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    redirects to /dashboard/&lt;tournament_id&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">global</span> <span class="n">tournament_cache</span>

    <span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">fencers_csv</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;fencers&#39;</span><span class="p">]</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
    <span class="n">num_pistes</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;pistes&#39;</span><span class="p">]</span>
    <span class="n">first_elimination_round</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;first_elimination_round&#39;</span><span class="p">]</span>
    <span class="n">elimination_mode</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;elimination_mode&#39;</span><span class="p">]</span>
    <span class="n">preliminary_rounds</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;number_of_preliminary_rounds&#39;</span><span class="p">]</span>
    <span class="n">preliminary_groups</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;number_of_preliminary_groups&#39;</span><span class="p">]</span>
    <span class="n">simulation_active</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;simulation_active&#39;</span><span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">simulation_active</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">simulation_active</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">))</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;master_password&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">hash_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>

    <span class="c1"># --- Process the data from the form</span>
    <span class="c1"># Process csv file</span>

    <span class="n">fencers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">csv_contents</span> <span class="o">=</span> <span class="n">fencers_csv</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_contents</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fencer_data</span> <span class="o">=</span> <span class="n">check_csv</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">CSVError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;CSV Error&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fencer_data</span><span class="p">:</span>
            <span class="n">fencer_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fencer_club</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">fencer_nationality</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">fencer_gender</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fencer_handedness</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">fencer_age</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="k">else</span> <span class="kc">None</span>

            <span class="n">fencers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Fencer</span><span class="p">(</span><span class="n">fencer_name</span><span class="p">,</span> <span class="n">fencer_club</span><span class="p">,</span> <span class="n">fencer_nationality</span><span class="p">,</span> <span class="n">fencer_gender</span><span class="p">,</span> <span class="n">fencer_handedness</span><span class="p">,</span> <span class="n">fencer_age</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">preliminary_rounds</span><span class="p">)))</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>


        <span class="c1"># Generate and save the new tournament</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">Tournament</span><span class="p">(</span><span class="n">random_generator</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span> <span class="n">password</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fencers</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">preliminary_rounds</span><span class="p">,</span> <span class="n">preliminary_groups</span><span class="p">,</span> <span class="n">first_elimination_round</span><span class="p">,</span> <span class="n">elimination_mode</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">num_pistes</span><span class="p">,</span> <span class="nb">bool</span><span class="p">(</span><span class="n">simulation_active</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">))</span>
        <span class="n">tournament_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Server Error&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>

    <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;tournament_id&#39;</span><span class="p">:</span> <span class="n">tournament</span><span class="o">.</span><span class="n">id</span><span class="p">}))</span>
    <span class="k">return</span> <span class="n">create_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">tournament</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span></div>
    


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/check-login&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/dashboard/check-login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_login</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a GET request to check if the user is logged in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/master-login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">master_login</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to login as a manager.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    redirects to /dashboard/&lt;tournament_id&gt;, 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    401</span>
<span class="sd">        On wrong password</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">tournament_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tournament&#39;</span><span class="p">]</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Login attempt as master&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tournament not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Tournament not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">check_password</span><span class="p">(</span><span class="n">password</span><span class="p">,</span> <span class="n">tournament</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;dashboard&#39;</span><span class="p">,</span> <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">create_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Wrong password&#39;</span><span class="p">}),</span> <span class="mi">401</span>


<div class="viewcode-block" id="login_fencer"><a class="viewcode-back" href="../main.html#main.login_fencer">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login-fencer&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_fencer</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to login as a fencer.</span>
<span class="sd">    Note: This is not implemented yet.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    404</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">tournament_id</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tournament_id&#39;</span><span class="p">]</span>
    <span class="n">search</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;search&#39;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span> 
        <span class="n">start_number</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">search</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">start_number</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">search</span>
    

    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tournament not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Tournament not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">start_number</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;No start number or name given&#39;</span><span class="p">}),</span> <span class="mi">400</span>
        <span class="k">elif</span> <span class="n">name</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fencer_id</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_id_by_name</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">start_number</span> <span class="ow">and</span> <span class="n">start_number</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">fencer_id</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_id_by_start_number</span><span class="p">(</span><span class="n">start_number</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fencer_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Fencer not found&#39;</span><span class="p">}),</span> <span class="mi">404</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fencer</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_by_id</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span>
            <span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="s1">&#39;Fencer found&#39;</span><span class="p">,</span>
            <span class="s1">&#39;tournament_id&#39;</span><span class="p">:</span> <span class="n">tournament_id</span><span class="p">,</span>
            <span class="s1">&#39;fencer_id&#39;</span><span class="p">:</span> <span class="n">fencer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">fencer</span><span class="p">),</span>
            <span class="p">}),</span> <span class="mi">200</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">create_cookie</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;fencer&quot;</span><span class="p">,</span> <span class="n">fencer_id</span><span class="o">=</span><span class="n">fencer</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/check-fencer-login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">check_fencer_login</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a GET request to check if the user is logged in.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fencer_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fencer_id&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;fencer&quot;</span><span class="p">,</span> <span class="n">fencer_id</span><span class="o">=</span><span class="n">fencer_id</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}),</span> <span class="mi">200</span>



<div class="viewcode-block" id="login_referee"><a class="viewcode-back" href="../main.html#main.login_referee">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login-referee&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login_referee</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to login as a referee.</span>
<span class="sd">    Note: This is not implemented yet.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    404</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO Implement</span>
    <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span></div>

<div class="viewcode-block" id="dashboard"><a class="viewcode-back" href="../main.html#main.dashboard">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/dashboard&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">dashboard</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request /&lt;tournament_id&gt;/dashboard the dashboard.html file from the templates folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dashboard.html 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;dashboard.html&#39;</span><span class="p">,</span> <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">)</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/qr&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">qr</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request /qr the qr.html file from the templates folder.</span>
<span class="sd">    This is the page where the QR code is displayed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    qr.html 200</span>
<span class="sd">        On success</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tournament&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;qr.html&#39;</span><span class="p">,</span> <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">)</span>

<div class="viewcode-block" id="get_dashboard_infos"><a class="viewcode-back" href="../main.html#main.get_dashboard_infos">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/dashboard/update&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_dashboard_infos</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on GET request /&lt;tournament_id&gt;/dashboard/update the dashboard infos as a json object.</span>
<span class="sd">    This includes general information about the tournament.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json object (from tournament.get_dashboard_infos()), 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">tournament</span><span class="o">.</span><span class="n">get_dashboard_infos</span><span class="p">())</span></div>


<div class="viewcode-block" id="matches"><a class="viewcode-back" href="../main.html#main.matches">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">matches</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/matches the matches.html file from the templates folder.</span>
<span class="sd">    This is the page where the matches are displayed and it is visible on the dashboard as an iframe and can be opened in fullscreen.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    matches.html, 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;/dashboard/matches.html&#39;</span><span class="p">,</span> <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">num_pistes</span><span class="o">=</span><span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">num_pistes</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_matches"><a class="viewcode-back" href="../main.html#main.get_matches">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/update&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_matches</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/matches/update all matches of the current state as a json object.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json object (from tournament.get_matches())</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">tournament</span><span class="o">.</span><span class="n">get_matches</span><span class="p">())</span></div>

<div class="viewcode-block" id="set_active"><a class="viewcode-back" href="../main.html#main.set_active">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/set_active&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">set_active</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to set a certain match as active.</span>

<span class="sd">    .. warning::</span>
<span class="sd">    The function will return a 400 Error Code, when the Piste that was assigned to the Match</span>
<span class="sd">    is still in use by another match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    match_id : str</span>
<span class="sd">        The id of the match.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200 (on success)</span>
<span class="sd">    400 (on PisteError)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="c1"># Get the match id from application/json response</span>
        <span class="n">match_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="n">match_id</span><span class="p">)</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="n">PisteError</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">400</span></div>

<div class="viewcode-block" id="push_score"><a class="viewcode-back" href="../main.html#main.push_score">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/push_score&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">push_score</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to push a score of a finished match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    match_id : str</span>
<span class="sd">        The id of the match.</span>
<span class="sd">    green_score : int</span>
<span class="sd">        The score of the green fencer.</span>
<span class="sd">    red_score : int</span>
<span class="sd">        The score of the red fencer.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="n">match_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>

    <span class="c1"># Check if logged in as referee or master</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;referee&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s1">&#39;master&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;User must be logged in as Master or Referee to input results!&quot;</span><span class="p">}),</span> <span class="mi">401</span>

    <span class="n">green_score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;green_score&#39;</span><span class="p">])</span>
    <span class="n">red_score</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;red_score&#39;</span><span class="p">])</span>
    <span class="n">tournament</span><span class="o">.</span><span class="n">push_score</span><span class="p">(</span><span class="n">match_id</span><span class="p">,</span> <span class="n">green_score</span><span class="p">,</span> <span class="n">red_score</span><span class="p">)</span>
    <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/prioritize&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">prioritize</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to prioritize a match in the piste-assignment-process.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    match_id : str</span>
<span class="sd">        The id of the match.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="n">match_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
    <span class="n">tournament</span><span class="o">.</span><span class="n">prioritize_match</span><span class="p">(</span><span class="n">match_id</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/assign_piste&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">assign_piste</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to assign a piste to a match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    match_id : str</span>
<span class="sd">        The id of the match.</span>
<span class="sd">    piste : int</span>
<span class="sd">        The number of the piste.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">match_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">piste</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;piste&#39;</span><span class="p">])</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">assign_certain_piste</span><span class="p">(</span><span class="n">match_id</span><span class="p">,</span> <span class="n">piste</span><span class="p">)</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">e</span><span class="p">}}),</span> <span class="mi">400</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches/remove_piste_assignment&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">remove_piste_assignment</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to remove a piste assignment from a match.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    match_id : str</span>
<span class="sd">        The id of the match.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">match_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">remove_piste_assignment</span><span class="p">(</span><span class="n">match_id</span><span class="p">)</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">}),</span> <span class="mi">200</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>



<div class="viewcode-block" id="standings"><a class="viewcode-back" href="../main.html#main.standings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/standings&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">standings</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/standings the standings.html file from the templates folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    group : str</span>
<span class="sd">        The requested group (only if in Preliminary Stage). If ``group`` is &quot;all&quot;, overall standings are reported.</span>

<span class="sd">    Returns</span>
<span class="sd">    standings.html, 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;/dashboard/standings.html&#39;</span><span class="p">,</span> <span class="n">requested_group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">num_groups</span><span class="o">=</span><span class="n">tournament</span><span class="o">.</span><span class="n">get_num_groups</span><span class="p">(),</span> <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="get_standings"><a class="viewcode-back" href="../main.html#main.get_standings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/standings/update&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_standings</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/standings/update the standings of the current state as a json object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    group : str</span>
<span class="sd">        The requested group (only if in Preliminary Stage). If ``group`` is &quot;all&quot;, overall standings are reported.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json object (from tournament.get_standings()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="n">group</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>
    <span class="n">gender</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;gender&#39;</span><span class="p">)</span>
    <span class="n">handedness</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;handedness&#39;</span><span class="p">)</span>
    <span class="n">age_group</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">([])</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">tournament</span><span class="o">.</span><span class="n">get_standings</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">gender</span><span class="p">,</span> <span class="n">handedness</span><span class="p">,</span> <span class="n">age_group</span><span class="p">))</span></div>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/standings/fencer/&lt;fencer_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">redirict_fencer_from_standings</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">fencer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a GET request to redirect to the fencer page from the standings page.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    fencer_id : str</span>
<span class="sd">        The id of the fencer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    302</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">tournament_id</span><span class="si">}</span><span class="s1">/fencer/</span><span class="si">{</span><span class="n">fencer_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="matches_left"><a class="viewcode-back" href="../main.html#main.matches_left">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/matches-left&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">matches_left</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/matches-left the number of matches left in the current stage as a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str (from tournament.get_matches_left()</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_matches_left</span><span class="p">()</span></div>

<div class="viewcode-block" id="next_stage"><a class="viewcode-back" href="../main.html#main.next_stage">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/next-stage&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">next_stage</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a GET request to go to the next stage.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">next_stage</span><span class="p">()</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>

        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span></div>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/fencer/&lt;fencer_id&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">fencer</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">fencer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/fencer/&lt;fencer_id&gt; the fencer.html file from the templates folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    fencer_id : str</span>
<span class="sd">        The id of the fencer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fencer.html, 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">fencer</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_object</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fencer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;/fencer.html&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">fencer</span><span class="o">.</span><span class="n">short_str</span><span class="p">,</span>
                <span class="n">club</span><span class="o">=</span><span class="n">fencer</span><span class="o">.</span><span class="n">club</span><span class="p">,</span>
                <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">fencer_id</span><span class="o">=</span><span class="n">fencer</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">APP_VERSION</span>
                <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/fencer/&lt;fencer_id&gt;/update&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_fencer</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">fencer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/fencer/&lt;fencer_id&gt;/update the fencer object as a json object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    fencer_id : str</span>
<span class="sd">        The id of the fencer.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json object (from tournament.get_fencer_object()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
        
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_hub_information</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">))</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/fencer/&lt;fencer_id&gt;/change_attribute&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">change_fencer_attribute</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">,</span> <span class="n">fencer_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    
    <span class="c1"># TODO Check if logged in as fencer or manager</span>

    <span class="n">attribute</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">attribute</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;club&quot;</span><span class="p">,</span> <span class="s2">&quot;nationality&quot;</span><span class="p">,</span> <span class="s2">&quot;gender&quot;</span><span class="p">,</span> <span class="s2">&quot;handedness&quot;</span><span class="p">,</span> <span class="s2">&quot;age&quot;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid attribute name&quot;</span><span class="p">})</span>
    
    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid value&quot;</span><span class="p">})</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">get_fencer_by_id</span><span class="p">(</span><span class="n">fencer_id</span><span class="p">)</span><span class="o">.</span><span class="n">change_attribute</span><span class="p">(</span><span class="n">attribute</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)})</span>
    


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/tableau&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">tableau</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/tableau/&lt;round&gt;/&lt;group&gt; the tableau.html file from the templates folder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    round : str</span>
<span class="sd">        The requested round (only if in Preliminary Stage). If ``round`` is &quot;all&quot;, overall standings are reported.</span>
<span class="sd">    group : str</span>
<span class="sd">        The requested group (only if in Preliminary Stage). If ``group`` is &quot;all&quot;, overall standings are reported.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tableau.html, 200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;/tableau.html&#39;</span><span class="p">,</span>
            <span class="nb">round</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;round&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;round&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">preliminary_stage</span><span class="p">,</span>
            <span class="n">group</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">),</span>
            <span class="n">tournament_id</span><span class="o">=</span><span class="n">tournament_id</span><span class="p">,</span>
            <span class="n">num_groups</span><span class="o">=</span><span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">get_num_groups</span><span class="p">()</span>
            <span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/tableau/update&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_tableau</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /&lt;tournament_id&gt;/tableau/&lt;round&gt;/&lt;group&gt;/update the tableau object as a json object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    round : str</span>
<span class="sd">        The requested round (only if in Preliminary Stage). If ``round`` is &quot;all&quot;, overall standings are reported.</span>
<span class="sd">    group : str</span>
<span class="sd">        The requested group (only if in Preliminary Stage). If ``group`` is &quot;all&quot;, overall standings are reported.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    json object (from tournament.get_tableau_object()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tournament</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">([]),</span> <span class="mi">404</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">tournament</span><span class="o">.</span><span class="n">get_tableau_array</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">),</span> <span class="mi">200</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/tableau/approve&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">approve_tableau</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a POST request to approve the tableau by a certain Fencer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>
<span class="sd">    round : str</span>
<span class="sd">        The requested round (only if in Preliminary Stage). If ``round`` is &quot;all&quot;, overall standings are reported.</span>
<span class="sd">    group : str</span>
<span class="sd">        The requested group (only if in Preliminary Stage). If ``group`` is &quot;all&quot;, overall standings are reported.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">        On success</span>
<span class="sd">    304</span>
<span class="sd">        On already approved tableau</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
        <span class="n">prelim_round</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;round&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">prelim_round</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">prelim_round</span> <span class="o">==</span> <span class="p">(</span><span class="mi">1</span><span class="p">,):</span>
            <span class="n">prelim_round</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">preliminary_stage</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;group&#39;</span><span class="p">)</span>

        <span class="c1"># Check if Cookie for logged in fencer exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_logged_in</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">tournament_id</span><span class="p">,</span> <span class="s2">&quot;fencer&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fencer_id&#39;</span><span class="p">]):</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;You are not logged in as the correct fencer.&quot;</span><span class="p">}),</span> <span class="mi">403</span>
        
        <span class="c1"># Check if Cookie with device_id exists</span>
        <span class="k">if</span> <span class="s1">&#39;device_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="n">device_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">device_id</span> <span class="o">=</span> <span class="n">random_generator</span><span class="o">.</span><span class="n">id</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span><span class="o">.</span><span class="n">approve_tableau</span><span class="p">(</span><span class="n">prelim_round</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;timestamp&#39;</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;fencer_id&#39;</span><span class="p">],</span> <span class="n">device_id</span><span class="p">),</span> <span class="mi">200</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;device_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="n">response</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="s1">&#39;device_id&#39;</span><span class="p">,</span> <span class="n">device_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/get-my-device-id&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">get_my_device_id</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s1">&#39;device_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;device_id&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;device_id&#39;</span><span class="p">]})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;success&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;No device_id cookie found&quot;</span><span class="p">})</span>


<div class="viewcode-block" id="simulate_current"><a class="viewcode-back" href="../main.html#main.simulate_current">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&lt;tournament_id&gt;/simulate-current&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">simulate_current</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask processes a GET request to simulate all matches of the current stage.</span>
<span class="sd">    This is only used for testing purposes and will be deprecated in later versions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    tournament_id : str</span>
<span class="sd">        The id of the tournament.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    200</span>
<span class="sd">        On success</span>
<span class="sd">    404</span>
<span class="sd">        On tournament not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">check_tournament_exists</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">):</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tournament</span> <span class="o">=</span> <span class="n">get_tournament</span><span class="p">(</span><span class="n">tournament_id</span><span class="p">)</span>
        <span class="n">tournament</span><span class="o">.</span><span class="n">simulate_current</span><span class="p">()</span>
        <span class="n">save_tournament</span><span class="p">(</span><span class="n">tournament</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">200</span></div>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/docs/&lt;path:filename&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">serve_docs</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves and renders on a GET request /docs/build/index.html file from the docs folder. This is the documentation.</span>
<span class="sd">    The documentation is built using Sphinx. See the docs folder for more information.</span>
<span class="sd">    The template is based on the Read the Docs theme.</span>
<span class="sd">    </span>
<span class="sd">    The template is not in the templates folder, the path has to be specified manually.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># If the file does not have an extension, add .html</span>
    <span class="k">if</span> <span class="s1">&#39;.&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">+=</span> <span class="s1">&#39;.html&#39;</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="s1">&#39;docs/build&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/docs&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">redirect_docs</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask redirects on a GET request /docs to /docs/build/index.html.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;serve_docs&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;index.html&#39;</span><span class="p">))</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logs/flask&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_flask_logs</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flask serves on a GET request /logs/flask the flask.log file from the logs folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="s1">&#39;logs&#39;</span><span class="p">,</span> <span class="s1">&#39;flask.log&#39;</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/github-webhook&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_webhook</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># # Verify the signature</span>
    <span class="c1"># signature = request.headers.get(&#39;X-Hub-Signature-256&#39;)</span>
    <span class="c1"># if not signature:</span>
    <span class="c1">#     return &#39;No signature found&#39;, 400</span>
    <span class="c1"># try:</span>
    <span class="c1">#     algorithm, signature = signature.split(&#39;=&#39;)</span>
    <span class="c1">#     if algorithm != &#39;sha256&#39;:</span>
    <span class="c1">#         raise ValueError</span>
    <span class="c1"># except ValueError:</span>
    <span class="c1">#     return &#39;Invalid algorithm&#39;, 400</span>
    <span class="c1"># mac = hmac.new(github_secret.encode(), msg=request.data, digestmod=hashlib.sha256)</span>
    <span class="c1"># if not hmac.compare_digest(mac.hexdigest(), signature):</span>
    <span class="c1">#     return &#39;Invalid signature&#39;, 400</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s1">&#39;bash&#39;</span> <span class="p">,</span><span class="s1">&#39;update_server.sh&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Error: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="mi">500</span>

    <span class="k">return</span> <span class="s1">&#39;Webhook received&#39;</span><span class="p">,</span> <span class="mi">200</span>



<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">page_not_found</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    404 Error handler: Flask serves on a 404 Error the 404.html file from the templates folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;404.html&#39;</span><span class="p">),</span> <span class="mi">404</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_server_error</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    500 Error handler: Flask serves on a 500 Error the 500.html file from the templates folder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;500.html&#39;</span><span class="p">),</span> <span class="mi">500</span>


<span class="c1"># ------- Flask Mail -------</span>




<span class="c1"># ------- Testing locally -------</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">load_all_tournaments</span><span class="p">()</span>
    <span class="n">delete_old_tournaments</span><span class="p">()</span>


    <span class="c1"># ---------- Activate the following boolean to run the server on port 8080 locally ---------- #</span>
    <span class="n">port_flask</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># ---------- Activate the following boolean to run the server in debug mode ---------- #</span>
    <span class="n">debug_flask</span> <span class="o">=</span> <span class="kc">True</span>


    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="s1">&#39;flask.log&#39;</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">port_flask</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8080</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_flask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_flask</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, CC BY-NC, Tade Strehk, Moritz Hellmich.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>